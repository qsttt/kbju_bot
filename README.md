# File: `README.md`

````markdown
# kbju_bot

–¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç –¥–ª—è —É—á—ë—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è (–ö–ë–ñ–£). Aiogram 3 + SQLAlchemy async + Alembic. –ï—Å—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π FastAPI-—Å–µ—Ä–≤–∏—Å –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤/–∞–¥–º–∏–Ω–∫–∏.

## 1) –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
````

## 2) –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` ‚Üí `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è.

–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

* `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–∞
* `DATABASE_URL` ‚Äî SQLite (dev) –∏–ª–∏ PostgreSQL (prod)
* `ADMIN_DASHBOARD_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ –∏ –∑–∞—â–∏—Ç—ã –≤–µ–±—Ö—É–∫–∞
* (–æ–ø—Ü.) Edamam/FDC/Gemini/YooKassa ‚Äî –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–ü—Ä–∏–º–µ—Ä—ã `DATABASE_URL`:

* SQLite (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ dev): `sqlite+aiosqlite:///./kbju.db`
* PostgreSQL: `postgresql+asyncpg://kbju_user:password@127.0.0.1:5432/kbju`

## 3) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î

–°—Ö–µ–º–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Alembic. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `DATABASE_URL` –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.

```bash
alembic upgrade head
```

> Alembic –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ **SYNC-—Ä–µ–∂–∏–º–µ** (psycopg) ‚Äî —ç—Ç–æ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ `migrations/env.py`.

## 4) –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
python main.py
```

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

* `/start` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
* `/summary` ‚Äî —Å–≤–æ–¥–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
* `/diag` ‚Äî –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

## 5) –ó–∞–ø—É—Å–∫ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ API-—Å–µ—Ä–≤–µ—Ä–∞ (–≤–µ–±—Ö—É–∫–∏/–∞–¥–º–∏–Ω–∫–∞)

```bash
uvicorn api_server:app --host 0.0.0.0 --port 8080
```

### 5.1 –í–µ–±—Ö—É–∫ YooKassa

* –≠–Ω–¥–ø–æ–∏–Ω—Ç: `POST /payment/callback`
* –ó–∞—â–∏—Ç–∞: —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Admin-Token: <ADMIN_DASHBOARD_TOKEN>`
* –õ–æ–≥–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø—Ä–∏ `payment.succeeded` –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º–∞ –Ω–∞ 30 –¥–Ω–µ–π; –≤ –ë–î –ø–∏—à–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –æ –ø–ª–∞—Ç–µ–∂–µ.

> –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –¥–æ–±–∞–≤—å—Ç–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–∞ YooKassa –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (—Å–µ–π—á–∞—Å –±–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å).

### 5.2 Admin Dashboard (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π)

* –ú–µ—Ç—Ä–∏–∫–∏: `GET /admin/metrics`
* –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–µ–º–∏—É–º-–∞–∫—Ç–∏–≤–∞—Ü–∏–∏: `GET /admin/trials`
* –î–æ—Å—Ç—É–ø: —Ç–æ—Ç –∂–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Admin-Token`.

## 6) –ó–∞–º–µ—Ç–∫–∏ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

* `core/models.py` ‚Äî –º–æ–¥–µ–ª–∏ (–≤ —Ç–æ–º —á–∏—Å–ª–µ `SourceEnum = manual|api|preset`)
* `core/crud.py` ‚Äî CRUD (+ `set_premium_until`, `log_payment`)
* `bot/handlers/*` ‚Äî —Ö–µ–Ω–¥–ª–µ—Ä—ã aiogram (Reply/Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤ `bot/keyboards/*`)
* `api/*` ‚Äî –∫–ª–∏–µ–Ω—Ç—ã –≤–Ω–µ—à–Ω–∏—Ö API (Edamam/FDC/Translate/YooKassa)
* `admin_dashboard/*` ‚Äî –ø—Ä–æ—Å—Ç—ã–µ HTML-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## 7) –ü—Ä–æ—Ñ–∏–ª—å/–°–≤–æ–¥–∫–∞/–ü—Ä–µ–º–∏—É–º ‚Äî UX

* –í–Ω—É—Ç—Ä–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ Reply-–º–µ–Ω—é —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –≤–µ–∑–¥–µ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ ¬´üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é¬ª
* –í–≤–æ–¥ –±–ª—é–¥–∞: —Ü–µ–ø–æ—á–∫–∞ `Edamam ‚Üí FDC ‚Üí Presets ‚Üí —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –∫–∫–∞–ª`

## 8) –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è SQLite –≤ dev, PostgreSQL –≤ prod
* –î–æ–±–∞–≤—å—Ç–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã –¥–ª—è `bot/utils/parser.py`, CRUD –∏ —Ü–µ–ø–æ—á–∫–∏ –ø–æ–∏—Å–∫–∞ (–º–æ–∫–∏)

## 9) –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

* **–ü–∞–¥–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç** ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `core/constants.py` (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ñ–æ–ª—Ç –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö)
* **–ú–∏–≥—Ä–∞—Ü–∏–∏** ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –º–∏–≥—Ä–∞—Ü–∏—è `update source_enum`

---

¬© 2025 kbju_bot

```
```